name: Auto-Add "ascend" Label on Creation
on:
  issues:
    types: [opened]
  pull_request:
    types: [opened]

permissions:
  issues: write
  pull-requests: write

jobs:
  add_ascend_label:
    runs-on: ubuntu-latest
    steps:
      - name: Add Ascend Label on Creation
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // 1. Extract the event type and relevant data
              const isIssue = context.eventName === 'issues';
              const title = isIssue
                ? context.payload.issue.title.toLowerCase()
                : context.payload.pull_request.title.toLowerCase();

              const body = isIssue
                ? context.payload.issue.body?.toLowerCase() || ''
                : context.payload.pull_request.body?.toLowerCase() || '';

              const owner = context.repo.owner;
              const repo = context.repo.repo;
              const number = isIssue
                ? context.payload.issue.number
                : context.payload.pull_request.number;

              const content = `${title} ${body}`;
            
              // 2. Check if the content contains the keyword "ascend"
              if (!content.includes('ascend')) {
                console.log('No "ascend" keyword found in title/body. Skipping.');
                return;
              }

              // 3. Fetch the current issue/pr to check existing lables
              const labelsResponse = await (isIssue
                ? github.rest.issues.listLabelsOnIssue
                : github.rest.pulls.listLabelsOnPullRequest)({
                  owner: owner,
                  repo: repo,
                  issue_number: number,
                });
                          
              // 4. Avoid duplicate label addition
              const existingLabels = labelsResponse.data?.map(label => label.name) || [];
              if (existingLabels.includes('ascend')) {
                console.log('Label "ascend" already exists. Skipping.');
                return;
              }
            
              // 5. Add the "ascend" label
              const addLabelsEndpoint = isIssue
                ? github.rest.issues.addLabels
                : github.rest.pulls.addLabels;
                
              await addLabelsEndpoint({
                owner: owner,
                repo: repo,
                issue_number: number,
                labels: ['ascend']
              });
              console.log('Successfully added "ascend" label.');
            } catch (error) {
                console.error('Error adding label:', error);
            }
