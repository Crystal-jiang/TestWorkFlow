name: Issue & PR Labeler
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write

jobs:
  add_ascend_label:
    runs-on: ubuntu-latest
    steps:
      - name: Add Ascend Label
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const body = context.payload.comment.body.toLowerCase();
              const owner = context.repo.owner;
              const repo = context.repo.repo;

              // 1. Determine issue or pr
              let issueNumber;
              let getMethod;

              if (context.eventName === 'issue_comment') {
                issueNumber = context.issue.number;
                getMethod = github.rest.issues.get;
              } else if (context.eventName === 'pull_request_review_comment') {
                issueNumber = context.payload.pull-request.number;
                getMethod = github.rest.pulls.get;
              } else {
                console.log('Unsupported event type, Skipping.');
                return;
              }
            
              // 2. Check if the comment contains the keyword "ascend"
              if (!body.includes('ascend')) {
                console.log('No "ascend" keyword found. Skipping.');
                return;
              }

              // 3. Fetch the current issue/pr to check existing lables
              const reponse = await getMethod({
                owner: owner,
                repo: repo,
                issue_number: issueNumber,
              });
                          
              // 4. Avoid duplicate label addition
              const existingLabels = response.data.labels?.map(label => label.name) || [];
              if (existingLabels.includes('ascend')) {
                console.log('Label "ascend" already exists. Skipping.');
                return;
              }
            
              // 5. Add the "ascend" label
              const targetEndpoint = context.eventName === 'issue_comment'
                ? github.rest.issues.addLabels
                : github.rest.pulls.addLabels;
                
              await targetEndpoint({
                owner: owner,
                repo: repo,
                issue_number: issueNumber,
                labels: ['ascend']
              });
              console.log('Successfully added "ascend" label.');
            } catch (error) {
                console.error('Error adding label:', error);
            }
